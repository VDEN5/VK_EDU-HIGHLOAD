# Почтовый сервис Mail.ru

## Содержание
- [Тема, целевая аудитория и MVP](#тема-целевая-аудитория-и-mvp)
  - [Тема](#тема)
  - [MVP](#mvp)
  - [Сведения](#сведения)
- [Аудитория](#аудитория)
- [Продуктовые показатели](#продуктовые-показатели)
- [Расчет нагрузки](#расчет-нагрузки)
- [Объем хранилищ](#объем-хранилищ)
- [Список источников](#список-источников)

## Тема, целевая аудитория и MVP

### Тема 
Mail.ru - сервис для отправки электронных писем

### MVP
Функционал:
1) отправка письма
2) просмотр письма
3) удаление письма
4) создание избранных писем
5) поиск писем (в том числе и по параметрам)
6) создание папок

### Сведения
1) 49M MAU [1]
2) 16,2M DAU [2]
3) 20 000 000 писем отправляются в день [3]
4) 37% респондентов проверяют почту несколько раз в сутки, у 22% она всегда открыта в течение дня. 20% - раз в день, 11% – раз в неделю. 7% - крайне редко, а 3% - очень давно [4]
5) 50 пб - хранилище mail.ru. Из них 15 пб - письма, 35 пб - вложения (файлы) [2]
6) 8 гб - бесплатный размер хранилища писем mail.ru [5]
7) Средний вес письма без вложения 75 кб [6]
8) Максимальный размер вложений 25 мб [6]
9) 100 млн активных пользователей [7]
10) По данным специалистов Почты Mail.Ru около 50% всех писем в Мобильной Почте Mail.Ru отправляются с вложениями. В каждом пятом письме — два и более прикрепленных файла. Примерно в 80% случаях — это фотографии, 19% — документы, 1% приходится на видеоролики и архивы [8]

## Аудитория
Распределение трафика по странам [9]

| Процент | Страна |
| ------- | ------ |
| 90 % | Россия |
| 4 % | Казахстан |
| 4 % | Белоруссия |
| 1 % | Азербайджан |
| 1 % | Европа |

## Продуктовые показатели
| Название | Показатель | Расчет |
| -------- | ---------- | ------ |
| MAU | 49 млн/месяц | из данных |
| DAU | 17 млн/день | из данных |
| Отправка писем | 20 млн/день | из данных |
| Получение писем | 500 тыс/мин | из данных |
| Письмо без вложения | 75 кб | из данных |
| Письмо с вложением | 1125 кб | Из данных: фотографии: 80% (2000 кб), документы: 19% (500 кб), видеоролики и архивы: 1% (10000 кб) <br> Средний вес вложения = (0.8×2000) + (0.19×500) + (0.01×10000) = 1795 кб <br> 80% писем с вложениями содержат один файл 1795 кб + 75 кб = 1870 кб <br> 20% писем с вложениями содержат два и более файла (возьмем 2): 2×1795 кб + 75 кб = 3665 кб <br> Средний вес с вложением = (0.8×1870) + (0.2×3665) = 2229 кб <br> Средний вес = (0.5×75) + (0.5×2229) = 1152 кб |
| Письмо | 600 кб | из данных имеем 50% отправляются с вложениями (то есть половина), тогда Средний вес=(1125+75)/2=600 кб |
| Хранилище | 0,5 гб/пользователь | 50 млн MAU - количество хранилищ. 50 пб / 100 млн пользователей = 0,52 гб |
| Проверка почты | 45 раз/день | Пусть 37% — проверяют почту 3 раза в сутки, 22% — 200 раз, 20% — 1 раз, 11% — 0.14, 7% — 0.01, 3% — 0. <br> Тогда среднее число проверок в день = (0.37×3) + (0.22×200) + (0.20×1) + (0.11×0.14) + (0.07×0.01) + (0.03×0) = 45.3254 |
| Пользователи | 100 млн | В источнике указаны активные пользователи. Пусть это и будет нашим числом пользователей |

## Расчет нагрузки
| Запрос | RPS | Расчет RPS | Traffic | Расчет трафика |
| ------ | --- | ---------- | ------- | -------------- |
| Создание и отправка письма | 231 | Отправка писем / 86400 = 20 млн / 86400 | 1284 мбит/с | Отправка писем * Письмо / 86400 = 20 млн * 600 кб / 86400 = 20,000,000 × 600 × 8 / 86400 ≈ 1284 мбит/с |
| Просмотр страницы писем | 8854 | Проверка почты * DAU / 86400 = 45 * 17 млн / 86400 | 8846 мбит/с | Предположим, что при проверке почты открываются заголовки входящих на 1 странице (50 заголовков писем). Для отображения будем использовать заголовки соответствующих писем (метаинформацию). Пусть размер заголовка равен 2 Кб. <br> Проверка почты * DAU * 50 * Размер заголовка / 86400 = 45 * 17 млн * 50 * 2 / 86400 = 45 × 17,000,000 × 50 × 2 × 8 / 86400 ≈ 8846 мбит/с |
| Просмотр письма с вложениями | 26562 | Предположим, что при проверке почты пользователь открывает 3 письма с вложениями, скачивая их. <br> 3 * Проверка почты * DAU / 86400 = 3 * 45 * 17 млн / 86400 | 224 мбит/с | Скачивание 3 писем <br> 3 * Проверка почты * DAU * Письмо с вложением / 86400 = 3 * 45 * 17 млн * 1125 кб / 86400 = 3 × 45 × 17,000,000 × 1125 × 8 / 86400 ≈ 223,8 мбит/с |
| Сохранение в избранное | 266 | Пусть в избранное добавляется 1% от всех просматриваемых писем. <br> (Просмотр писем * 1%) / 86400 = (26562 RPS * 86400 * 0.01) / 86400 = 266 | 1.06 мбит/с | Пусть вес запроса — это просто флаг "добавить в избранное" <br> RPS * Вес запроса = 266 * 0.5 Кб * 8 ≈ 1064 кбит/с ≈ 1.06 мбит/с |
| Поисковые запросы | 590 | 3 поисковых запроса на пользователя в день <br> (17 млн DAU * 3) / 86400 ≈ 590 | 472 мбит/с | Вес запроса - строка поиска (0.2 Кб). Вес ответа - заголовки 50 найденных писем (50 * 2 Кб = 100 Кб). Общий вес операции = 100 Кб <br> RPS * Вес операции * 8 = 590 * 100 Кб * 8 = 590 × 100 × 8 / 1000 ≈ 472 мбит/с |

## Объем хранилищ
| Тип | Объем | Расчет |
| --- | ----- | ------ |
| Письма | 15 пб | Из данных |
| Вложения | 35 пб | Из данных |
| Личная информация | 96 тб | Личная информация - данные (ФИО, пароль, техническая информация, почта) 10 кб + аватарка 1 мб = 1034 кб <br> Пользователи * 1034 кб = 100 млн * 1034 кб |

## Глобальная балансировка нагрузки

### Распределение трафика по странам

| Страна         | Процент пользователей |
|----------------|-----------------------|
| Россия         | 90 %                  |
| Казахстан      | 4 %                   |
| Белоруссия     | 4 %                   |
| Азербайджан    | 1 %                   |
| Германия       | 1 %                   |

### Расположение ДЦ

Для оптимального размещения дата-центров на основании географического распределения пользователей было выбрано следующее расположение:

| Локация                    | Процент пользователей | Обоснование |
|----------------------------|-----------------------|-------------|
| **Беларусь (Минск)**       | 21% (~2.2k RPS)      | Обслуживает Беларусь (4%), европейских пользователей (Германия 1%), а также северо-западные и центральные регионы России (около 16% от общего трафика). |
| **Россия (Москва)**        | 25% (~2.5k RPS)      | Ключевой хаб для Центрального федерального округа и соседних областей. Обрабатывает трафик из наиболее плотно населенных регионов России. |
| **Россия (Ростов-на-Дону)**| 22% (~2.1k RPS)      | Обслуживает Юг России, Северный Кавказ, а также часть трафика из сопредельных стран. Стратегическое расположение для южного направления. |
| **Россия (Екатеринбург)**  | 18% (~1.8k RPS)      | Ответственен за Уральский федеральный округ, Западную Сибирь и Казахстан (4%). Ключевой узел для азиатской части России. |
| **Россия (Новосибирск)**   | 14% (~1.4k RPS)      | Покрывает Сибирь и Дальний Восток, обеспечивая низкую задержку для восточных регионов страны. |

### Latency-based DNS балансировка

Т.к. все датацентры расположены в относительно близких географических зонах, использование Geo-based DNS было бы неэффективно. Поэтому для достижения максимального быстродействия используется **Latency-based DNS**.

**Принцип работы:**
- DNS-система постоянно измеряет задержку (latency) между пользователем и каждым дата-центром
- Пользователь автоматически направляется к ДЦ с наименьшей задержкой
- Позволяет динамически адаптироваться к изменениям в сетевой инфраструктуре

**Преимущества для нашей архитектуры:**
- Оптимальное распределение трафика между 5 ДЦ без жесткой географической привязки
- Автоматическая балансировка при пиковых нагрузках или сбоях на отдельных линиях связи
- Учет реальной сетевой задержки, а не приблизительного географического положения
- Обеспечивает минимальное время отклика для пользователей из всех регионов

## Локальная балансировка нагрузки
Будем использовать L4 и L7 балансировщики:  
1. Балансировка SMTP-трафика (L4):  
NGINX  
Алгоритм: Least Connections    
Задачи: равномерное распределение нагрузки между SMTP-серверами. Используется L4 балансировка, так как анализ содержимого при отправке не происходит    
2. Балансировка IMAP/POP3-трафика (L4):  
NGINX  
Алгоритм: Source IP Hash    
Задачи: сохранение сессий пользователей, так как сессии IMAP/POP3 длительные  
3. Балансировка HTTP/HTTPS-трафика (L7):  
NGINX   
Алгоритм: Round Robin для статики и Least Connections для API   
Задачи: разделение трафика на статический контент и API  
4. Оркестрация сервисами с помощью Kubernetes  
5. Обеспечение отказоустойчивости - keepalived  
6. SSL Termination - сертификаты SSL будет проверять балансировщик, для того, чтобы снизить нагрузку на сервера 

## Список источников
1) [Годовой отчет VK Group](https://corp.vkcdn.ru/media/files/VK_AR2023_RUS_06.06_3KIGigO.pdf)
2) [Квартальный отчет VK Group](https://corp.vkcdn.ru/media/files/RUS_Press_Release_9M_2024.pdf)
3) [Регистрация](https://new.mail.ru/?ysclid=m798h0dap763791521)
4) [Исследование](https://news.rambler.ru/internet/47307976-issledovanie-rambler-co-65-rossiyskih-polzovateley-proveryayut-elektronnuyu-pochtu-s-noutbuka-ili-kompyutera/?ysclid=m7j44cvhnp258702465)
5) [Тарифы](https://help.mail.ru/cloud_web/size/tariffs/)
6) [Статистика](https://www.emailtooltester.com/en/blog/email-usage-statistics/)
7) [Анализ рынка](https://investim.guru/obzory/auditorii-osnovnyh-pochtovyh-servisov-v-rossii-statistika-i-analitika?utm_referrer=https%3A%2F%2Fya.ru%2F)
8) [Новость](https://hi-tech.mail.ru/news/123435-rossiyan-predupredili-o-neochevidnoj-ulovke-v-elektronnyh-pismah/?from=swap&swap=2)
9) [Трафик](https://www.similarweb.com/ru/website/mail.ru/)
