# Почтовый сервис Mail.ru

## Содержание
- [Тема, целевая аудитория и MVP](#тема-целевая-аудитория-и-mvp)
  - [Тема](#тема)
  - [MVP](#mvp)
  - [Сведения](#сведения)
- [Аудитория](#аудитория)
- [Продуктовые показатели](#продуктовые-показатели)
- [Расчет нагрузки](#расчет-нагрузки)
- [Объем хранилищ](#объем-хранилищ)
- [Список источников](#список-источников)

## Тема, целевая аудитория и MVP

### Тема 
Mail.ru - сервис для отправки электронных писем

### MVP
Функционал:
1) отправка письма
2) просмотр письма
3) удаление письма
4) создание избранных писем
5) поиск писем (в том числе и по параметрам)
6) создание папок

### Сведения
1) 49M MAU [1]
2) 16,2M DAU [2]
3) 20 000 000 писем отправляются в день [3]
4) 37% респондентов проверяют почту несколько раз в сутки, у 22% она всегда открыта в течение дня. 20% - раз в день, 11% – раз в неделю. 7% - крайне редко, а 3% - очень давно [4]
5) 50 пб - хранилище mail.ru. Из них 15 пб - письма, 35 пб - вложения (файлы) [2]
6) 8 гб - бесплатный размер хранилища писем mail.ru [5]
7) Средний вес письма без вложения 75 кб [6]
8) Максимальный размер вложений 25 мб [6]
9) 100 млн активных пользователей [7]
10) По данным специалистов Почты Mail.Ru около 50% всех писем в Мобильной Почте Mail.Ru отправляются с вложениями. В каждом пятом письме — два и более прикрепленных файла. Примерно в 80% случаях — это фотографии, 19% — документы, 1% приходится на видеоролики и архивы [8]

## Аудитория
Распределение трафика по странам [9]

| Процент | Страна |
| ------- | ------ |
| 90 % | Россия |
| 4 % | Казахстан |
| 4 % | Белоруссия |
| 1 % | Азербайджан |
| 1 % | Европа |

## Продуктовые показатели
| Название | Показатель | Расчет |
| -------- | ---------- | ------ |
| MAU | 49 млн/месяц | из данных |
| DAU | 17 млн/день | из данных |
| Отправка писем | 20 млн/день | из данных |
| Получение писем | 500 тыс/мин | из данных |
| Письмо без вложения | 75 кб | из данных |
| Письмо с вложением | 1125 кб | Из данных: фотографии: 80% (2000 кб), документы: 19% (500 кб), видеоролики и архивы: 1% (10000 кб) <br> Средний вес вложения = (0.8×2000) + (0.19×500) + (0.01×10000) = 1795 кб <br> 80% писем с вложениями содержат один файл 1795 кб + 75 кб = 1870 кб <br> 20% писем с вложениями содержат два и более файла (возьмем 2): 2×1795 кб + 75 кб = 3665 кб <br> Средний вес с вложением = (0.8×1870) + (0.2×3665) = 2229 кб <br> Средний вес = (0.5×75) + (0.5×2229) = 1152 кб |
| Письмо | 600 кб | из данных имеем 50% отправляются с вложениями (то есть половина), тогда Средний вес=(1125+75)/2=600 кб |
| Хранилище | 0,5 гб/пользователь | 50 млн MAU - количество хранилищ. 50 пб / 100 млн пользователей = 0,52 гб |
| Проверка почты | 45 раз/день | Пусть 37% — проверяют почту 3 раза в сутки, 22% — 200 раз, 20% — 1 раз, 11% — 0.14, 7% — 0.01, 3% — 0. <br> Тогда среднее число проверок в день = (0.37×3) + (0.22×200) + (0.20×1) + (0.11×0.14) + (0.07×0.01) + (0.03×0) = 45.3254 |
| Пользователи | 100 млн | В источнике указаны активные пользователи. Пусть это и будет нашим числом пользователей |

## Расчет нагрузки
| Запрос | RPS | Расчет RPS | Traffic | Расчет трафика |
| ------ | --- | ---------- | ------- | -------------- |
| Создание и отправка письма | 231 | Отправка писем / 86400 = 20 млн / 86400 | 1284 мбит/с | Отправка писем * Письмо / 86400 = 20 млн * 600 кб / 86400 = 20,000,000 × 600 × 8 / 86400 ≈ 1284 мбит/с |
| Просмотр страницы писем | 8854 | Проверка почты * DAU / 86400 = 45 * 17 млн / 86400 | 8846 мбит/с | Предположим, что при проверке почты открываются заголовки входящих на 1 странице (50 заголовков писем). Для отображения будем использовать заголовки соответствующих писем (метаинформацию). Пусть размер заголовка равен 2 Кб. <br> Проверка почты * DAU * 50 * Размер заголовка / 86400 = 45 * 17 млн * 50 * 2 / 86400 = 45 × 17,000,000 × 50 × 2 × 8 / 86400 ≈ 8846 мбит/с |
| Просмотр письма с вложениями | 26562 | Предположим, что при проверке почты пользователь открывает 3 письма с вложениями, скачивая их. <br> 3 * Проверка почты * DAU / 86400 = 3 * 45 * 17 млн / 86400 | 224 мбит/с | Скачивание 3 писем <br> 3 * Проверка почты * DAU * Письмо с вложением / 86400 = 3 * 45 * 17 млн * 1125 кб / 86400 = 3 × 45 × 17,000,000 × 1125 × 8 / 86400 ≈ 223,8 мбит/с |
| Сохранение в избранное | 266 | Пусть в избранное добавляется 1% от всех просматриваемых писем. <br> (Просмотр писем * 1%) / 86400 = (26562 RPS * 86400 * 0.01) / 86400 = 266 | 1.06 мбит/с | Пусть вес запроса — это просто флаг "добавить в избранное" <br> RPS * Вес запроса = 266 * 0.5 Кб * 8 ≈ 1064 кбит/с ≈ 1.06 мбит/с |
| Поисковые запросы | 590 | 3 поисковых запроса на пользователя в день <br> (17 млн DAU * 3) / 86400 ≈ 590 | 472 мбит/с | Вес запроса - строка поиска (0.2 Кб). Вес ответа - заголовки 50 найденных писем (50 * 2 Кб = 100 Кб). Общий вес операции = 100 Кб <br> RPS * Вес операции * 8 = 590 * 100 Кб * 8 = 590 × 100 × 8 / 1000 ≈ 472 мбит/с |

## Объем хранилищ
| Тип | Объем | Расчет |
| --- | ----- | ------ |
| Письма | 15 пб | Из данных |
| Вложения | 35 пб | Из данных |
| Личная информация | 96 тб | Личная информация - данные (ФИО, пароль, техническая информация, почта) 10 кб + аватарка 1 мб = 1034 кб <br> Пользователи * 1034 кб = 100 млн * 1034 кб |

## Глобальная балансировка нагрузки

### Распределение трафика по странам

| Страна         | Процент пользователей |
|----------------|-----------------------|
| Россия         | 90 %                  |
| Казахстан      | 4 %                   |
| Белоруссия     | 4 %                   |
| Азербайджан    | 1 %                   |
| Германия       | 1 %                   |

### Расположение ДЦ

Для оптимального размещения дата-центров на основании географического распределения пользователей было выбрано следующее расположение:

| Локация                    | Процент пользователей | Обоснование |
|----------------------------|-----------------------|-------------|
| **Беларусь (Минск)**       | 21% (~2.2k RPS)      | Обслуживает Беларусь (4%), европейских пользователей (Германия 1%), а также северо-западные и центральные регионы России (около 16% от общего трафика). |
| **Россия (Москва)**        | 25% (~2.5k RPS)      | Ключевой хаб для Центрального федерального округа и соседних областей. Обрабатывает трафик из наиболее плотно населенных регионов России. |
| **Россия (Ростов-на-Дону)**| 22% (~2.1k RPS)      | Обслуживает Юг России, Северный Кавказ, а также часть трафика из сопредельных стран. Стратегическое расположение для южного направления. |
| **Россия (Екатеринбург)**  | 18% (~1.8k RPS)      | Ответственен за Уральский федеральный округ, Западную Сибирь и Казахстан (4%). Ключевой узел для азиатской части России. |
| **Россия (Новосибирск)**   | 14% (~1.4k RPS)      | Покрывает Сибирь и Дальний Восток, обеспечивая низкую задержку для восточных регионов страны. |

### Latency-based DNS балансировка

Т.к. все датацентры расположены в относительно близких географических зонах, использование Geo-based DNS было бы неэффективно. Поэтому для достижения максимального быстродействия используется **Latency-based DNS**.

**Принцип работы:**
- DNS-система постоянно измеряет задержку (latency) между пользователем и каждым дата-центром
- Пользователь автоматически направляется к ДЦ с наименьшей задержкой
- Позволяет динамически адаптироваться к изменениям в сетевой инфраструктуре

**Преимущества для нашей архитектуры:**
- Оптимальное распределение трафика между 5 ДЦ без жесткой географической привязки
- Автоматическая балансировка при пиковых нагрузках или сбоях на отдельных линиях связи
- Учет реальной сетевой задержки, а не приблизительного географического положения
- Обеспечивает минимальное время отклика для пользователей из всех регионов

# Локальная балансировка нагрузки

## Архитектура балансировки

### 1. Балансировка SMTP-трафика (L4)
**Решение:** NGINX  
**Алгоритм:** Least Connections  
**Задачи:** 
- Равномерное распределение нагрузки между SMTP-серверами
- Используется L4 балансировка, так как анализ содержимого при отправке не происходит
- Обеспечение отказоустойчивости почтового шлюза

### 2. Балансировка IMAP/POP3-трафика (L4)
**Решение:** NGINX  
**Алгоритм:** Source IP Hash  
**Задачи:**
- Сохранение сессий пользователей, так как сессии IMAP/POP3 длительные
- Гарантированное попадание пользователя на тот же сервер при повторном подключении
- Обработка постоянных соединений для почтовых клиентов

### 3. Балансировка HTTP/HTTPS-трафика (L7)
**Решение:** NGINX  
**Алгоритм:** 
- Round Robin для статического контента
- Least Connections для API-запросов
**Задачи:**
- Разделение трафика на статический контент и API
- Маршрутизация на основе URL пути (/api/, /static/, /attachments/)
- Кэширование статического контента на уровне балансировщика

### 4. Оркестрация сервисами с помощью Kubernetes

**Задачи:**
- **Автоматическое развертывание и масштабирование:** Динамическое увеличение или уменьшение количества подов (контейнеров) для каждого микросервиса в зависимости от нагрузки (CPU, memory)
- **Управление жизненным циклом:** Автоматический перезапуск упавших контейнеров для обеспечения высокой доступности сервиса
- **Эффективное использование ресурсов:** "Уплотнение" нескольких микросервисов на одном физическом хосте для снижения затрат на инфраструктуру

**Обоснование выбора:** Ручное управление сотнями серверов для динамичного почтового сервиса неэффективно. Kubernetes стал отраслевым стандартом для построения отказоустойчивых и легко масштабируемых систем, идеально подходя для микросервисной архитектуры.

### 5. Обеспечение отказоустойчивости - Keepalived

**Задачи:**
- **Ликвидация единой точки отказа:** Защита от выхода из строя самих балансировщиков
- **Создание виртуального IP-адреса (VIP):** Объединение физических серверов балансировщиков в группу с общим виртуальным IP
- **Автоматический фейловер:** При отказе активного балансировщика резервный автоматически берет на себя VIP в течение секунд

**Обоснование выбора:** Keepalived обеспечивает бесшовное переключение между балансировщиками с помощью VRRP (Virtual Router Redundancy Protocol), что критически важно для отказоустойчивости на entry-point трафика.

### 6. SSL Termination на балансировщике

**Задачи:**
- **Разгрузка backend-серверов:** Перенос ресурсоемких операций шифрования/дешифрования с application-серверов на балансировщики
- **Централизованное управление сертификатами:** Упрощение обновления и замены SSL-сертификатов
- **Возможность инспекции трафика:** Проведение продвинутой L7-балансировки и применение правил безопасности после расшифровки трафика

**Обоснование выбора:** Для высоконагруженного публичного сервиса SSL Termination на балансировщиках — стандартная практика, позволяющая значительно повысить общую пропускную способность системы.

## Логическая схема данных

<img width="361" alt="logic db" src="https://raw.githubusercontent.com/VDEN5/VK_EDU-HIGHLOAD/refs/heads/main/logicDB_2.png" />

### Таблица User (Пользователи)

| Поле         | Тип данных   | Размер (байты) |
|--------------|--------------|----------------|
| id           | int          | 4              |
| email        | text         | 255            |
| username     | text         | 255            |
| password     | text         | 255            |
| avatar_url   | text         | 255            |
| created_at   | timestamp    | 8              |
| updated_at   | timestamp    | 8              |
| **Итого**    |              | **1040**       |

**Расчеты:**
- Размер: 100 млн пользователей × 1040 байт = **96 ГБ**
- Количество строк: **100 млн**

### Таблица Email (Письма)

| Поле              | Тип данных   | Размер (байты) |
|-------------------|--------------|----------------|
| id                | int          | 4              |
| title             | text         | 255            |
| description       | text         | 255            |
| sender_email      | text         | 255            |
| recipient_email   | text         | 255            |
| message_id        | int          | 4              |
| parent_id         | int          | 4              |
| date              | timestamp    | 8              |
| isRead            | bool         | 1              |
| folder_id         | int          | 4              |
| created_at        | timestamp    | 8              |
| updated_at        | timestamp    | 8              |
| isDraft           | bool         | 1              |
| **Итого**         |              | **1062**       |

**Расчеты:**
- Количество писем за 5 лет: 20 млн/день × 365 дней × 5 лет = **36.5 млрд писем**
- Размер: 36.5 млрд × 1062 байт = **36 ТБ**

### Таблица Folder (Папки)

| Поле              | Тип данных   | Размер (байты) |
|-------------------|--------------|----------------|
| id                | int          | 4              |
| user_id           | int          | 4              |
| order_number      | int          | 4              |
| name              | text         | 255            |
| created_at        | timestamp    | 8              |
| updated_at        | timestamp    | 8              |
| is_system         | bool         | 1              |
| **Итого**         |              | **284**        |

**Расчеты:**
- Количество строк: 100 млн пользователей × 4 папки = **400 млн строк**
- Размер: 400 млн × 284 байта = **106 ГБ**

### Таблица Attachment (Вложения - метаданные)

| Поле              | Тип данных   | Размер (байты) |
|-------------------|--------------|----------------|
| id                | int          | 4              |
| email_id          | int          | 4              |
| filename          | varchar(255) | 255            |
| content_type      | varchar(100) | 100            |
| file_size         | int          | 4              |
| storage_path      | varchar(500) | 500            |
| created_at        | timestamp    | 8              |
| **Итого**         |              | **875**        |

**Расчеты:**
- Количество вложений: 36.5 млрд писем × 50% с вложениями × 1.2 вложения/письмо = **21.9 млрд вложений**
- Размер таблицы: 21.9 млрд × 875 байт = **18 ТБ**
- Файлы в объектном хранилище: **35 ПБ** (из исходных данных)

### Сводка по объемам хранилищ

| Компонент                     | Объем    |
|-------------------------------|----------|
| Таблица User                  | 96 ГБ    |
| Таблица Email                 | 36 ТБ    |
| Таблица Folder                | 106 ГБ   |
| Таблица Attachment (метаданные) | 18 ТБ    |
| **Общий объем БД**            | **~54 ТБ** |
| Файлы вложений (объектное хранилище) | **35 ПБ** |

### Нагрузка на чтение/запись

| Таблица           | Запросы                    | RPS     |
|-------------------|----------------------------|---------|
| User (чтение)     | подгрузка профиля, вход    | 295     |
| User (запись)     | регистрация, обновление профиля | 578     |
| Email (чтение)    | просмотр страницы писем    | 689     |
| Email (запись)    | отправка писем, черновики  | 4,397   |
| Folder (чтение)   | просмотр страницы писем    | 689     |
| Attachment (чтение) | просмотр письма с вложением | 2,065   |
| Attachment (запись) | отправка писем с вложениями | 115     |

### Физическая схема данных
<img width="456" alt="физическая база" src="https://raw.githubusercontent.com/VDEN5/VK_EDU-HIGHLOAD/refs/heads/main/physicalDB.png" />

### Индексы

**USER** (PostgreSQL)
1) Уникальный индекс для email - быстрая авторизация и проверка уникальности

**EMAIL** (Cassandra)
1) Основной индекс: (date, folder_id, recipient_email) - загрузка папок с пагинацией
2) Индекс sender_email - поиск по отправителю
3) Индекс (recipient_email, created_at DESC) - сортировка писем по дате (новые сначала)
4) Частичные индексы: read/unread, draft status - быстрая фильтрация

**ATTACHMENTS** (S3 + metadata в Cassandra)
1) Индекс по email_id - быстрая загрузка вложений для письма

### Выбор баз данных

| Таблица | БД | Комментарий | Шардирование | Резервирование |
|---------|----|-------------|--------------|----------------|
| Email | Cassandra | Горизонтальное масштабирование под 10 трлн писем, высокая скорость записи (4.3k RPS) | По хэшу email_id | 3 копии в разных дата-центрах |
| Folder | PostgreSQL | Маленькая таблица, редко изменяется, сложные связи | Не шардируется | Синхронная репликация (1 мастер + 2 реплики) |
| User | PostgreSQL | Небольшая таблица, требуется ACID для регистрации | Не шардируется | Синхронная репликация (1 мастер + 2 реплики) |
| Attachment | S3 + Cassandra | S3 - хранение файлов, Cassandra - метаданные | S3: по хэшу от email + дата | Версионирование + кросс-регион репликация |

### Денормализация

1) **unread_count в USER** - избегаем COUNT(*) при каждом входе пользователя
2) **sender_username, recipient_username в EMAIL** - убираем JOIN к users для отображения списка писем
3) **folder_name в EMAIL** - исключаем JOIN к folders при показе писем
4) **has_attachments в EMAIL** - быстрая проверка наличия вложений без запроса к attachments
5) **unread_count в FOLDER** - мгновенное отображение непрочитанных без агрегаций

### Клиентские библиотеки / Интеграции

1) **Redis** - кэширование сессий, счетчиков, горячих данных
2) **pgx** (Go драйвер для PostgreSQL) - пулинг соединений, подготовленные statements для users/folders
3) **aws-sdk-go/s3** - multipart upload больших файлов, pre-signed URLs для безопасного доступа
4) **gocql** (Go драйвер для Cassandra) - пакетные операции для массовой вставки писем, настройка уровней согласованности
5) **Elasticsearch** - полнотекстовый поиск по темам и содержимому писем

### Алгоритмы
| Технология | Область применения | Мотивация выбора |
|------------|-------------------|------------------|
| Go | Бэкенд-сервисы (API, обработка писем, аутентификация) | Нативная многопоточность через goroutines (миллионы одновременных соединений), компилируемый язык с производительностью C++ и простотой Python, минимальное потребление памяти |
| React + TypeScript | Веб-интерфейс почты | Virtual DOM для эффективного рендеринга больших списков писем, строгая типизация для предотвращения ошибок в сложном UI, богатая экосистема компонентов |
| Cassandra | Хранение писем и метаданных | Линейная масштабируемость под триллионы писем, отказоустойчивость на уровне дата-центров, оптимизация под write-heavy workload (20M писем/день) |
| Mail.ru Cloud Storage | Хранение вложений (файлы) | S3-совместимое объектное хранилище с репликацией, multipart upload для больших файлов до 25 МБ, экономия на разработке собственного решения |
| PostgreSQL | Хранение пользователей, папок, системных данных | Полная ACID-совместимость для критичных операций (регистрация, транзакции), сложные SQL-запросы для аналитики, надежность и стабильность |
| Redis | Кэширование сессий, горячих данных, очереди | In-memory производительность (<1ms), структуры данных для счетчиков непрочитанных, pub/sub для real-time уведомлений |
| RabbitMQ | Асинхронная обработка писем, нотификации | Гарантированная доставка сообщений, dead letter queues для обработки ошибок, поддержка различных протоколов (AMQP, MQTT) |
| Kubernetes | Оркестрация микросервисов | Автоматическое масштабирование под нагрузку (HPA), self-healing при падении сервисов, canary deployments для безопасных обновлений |
| NGINX | Балансировка нагрузки, SSL termination | Высокая производительность L7-балансировки, кэширование статики, маршрутизация на основе пути (/api/, /attachments/) |
| Prometheus | Сбор метрик в реальном времени | Multi-dimensional data model, мощный PromQL для анализа, автоматическое обнаружение сервисов в Kubernetes |
| Grafana | Визуализация метрик и дашборды | Богатая библиотека графиков, алертинг на аномалии, шаблонизация дашбордов для мониторинга производительности |

## Список источников
1) [Годовой отчет VK Group](https://corp.vkcdn.ru/media/files/VK_AR2023_RUS_06.06_3KIGigO.pdf)
2) [Квартальный отчет VK Group](https://corp.vkcdn.ru/media/files/RUS_Press_Release_9M_2024.pdf)
3) [Регистрация](https://new.mail.ru/?ysclid=m798h0dap763791521)
4) [Исследование](https://news.rambler.ru/internet/47307976-issledovanie-rambler-co-65-rossiyskih-polzovateley-proveryayut-elektronnuyu-pochtu-s-noutbuka-ili-kompyutera/?ysclid=m7j44cvhnp258702465)
5) [Тарифы](https://help.mail.ru/cloud_web/size/tariffs/)
6) [Статистика](https://www.emailtooltester.com/en/blog/email-usage-statistics/)
7) [Анализ рынка](https://investim.guru/obzory/auditorii-osnovnyh-pochtovyh-servisov-v-rossii-statistika-i-analitika?utm_referrer=https%3A%2F%2Fya.ru%2F)
8) [Новость](https://hi-tech.mail.ru/news/123435-rossiyan-predupredili-o-neochevidnoj-ulovke-v-elektronnyh-pismah/?from=swap&swap=2)
9) [Трафик](https://www.similarweb.com/ru/website/mail.ru/)
